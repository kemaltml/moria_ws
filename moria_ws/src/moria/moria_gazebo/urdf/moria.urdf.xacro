<?xml version="1.0"?>
<robot xmlns:xacro="http://www.ros.org/wiki/xacro" name="moria">

    <xacro:include filename="inertial_macros.xacro"/>
    
    <!--FLOOR DEFINITION - WORLD JOINT-->
    <link name="floor">
    </link>

    <!-- ROBOT DEFINITIONS-->
    <joint name="base_joint" type="fixed">
        <parent link="floor"/>
        <child link="base"/>
        <origin xyz="1 0 0.4"/>
    </joint>

        <!--BASE DEFINITION-->
    <link name="base">
        <visual>
            <origin xyz="0 0 0"/>
            <geometry>
                <mesh
                    filename="package://moria_description/meshes/base_link.STL" />
            </geometry>
            <material name="">
                <color rgba="0.79216 0.11961 0.93333 1"/>
            </material>
        </visual>
    
        <inertial>
            <origin
                xyz="-0.00044759 -0.044904 0.3116"/>
            <mass 
                value="3.027" />
            <inertia
                ixx="0.03787"
                ixy="0.00001"
                ixz="0.00001"
                iyy="0.04356"
                iyz="0.00008"
                izz="0.04447"
            />
        </inertial>
    </link>

        <!--LEFT WHEEL DEFINITION-->
    <joint name="left_wheel_joint" type="continuous">
        <parent link="base"/>
        <child link="left_wheel"/>
        <origin xyz="-0.13 -0.11 -0.33 " rpy="0 1.57 0"/>
        <axis xyz="0 0 -1"/>
    </joint>

    <link name="left_wheel">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder 
                    radius="0.05" 
                    length="0.04"
                />
            </geometry>
        </visual>
        <xacro:inertial_cylinder 
            mass="0.0261"
            length="0.04"
            radius="0.05"
        >
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_cylinder>
    </link>

        <!--RIGHT WHEEL DEFINITION-->
    <joint name="right_wheel_joint" type="continuous">
        <parent link="base"/>
        <child link="right_wheel"/>
        <origin xyz="0.13 -0.11 -0.33" rpy="0 1.57 0"/>
        <axis xyz="0 0 -1"/>
    </joint>

    <link name="right_wheel">
        <visual>
            <origin xyz="0 0 0" rpy="0 0 0"/>
            <geometry>
                <cylinder 
                    radius="0.05" 
                    length="0.04"
                />
            </geometry>
        </visual>
        <xacro:inertial_cylinder 
            mass="0.0261"
            length="0.04"
            radius="0.05"
        >
            <origin xyz="0 0 0" rpy="0 0 0"/>
        </xacro:inertial_cylinder>
    </link>

            <!--CASTER WHEEL DEFINITION-->
    <joint name="caster_joint" type="fixed">
        <parent link="base"/>
        <child link="caster_link"/>
        <origin xyz="0 0.12 -0.36" rpy="0 0 0"/>
    </joint>
    
    <link name="caster_link">
        <collision>
            <origin xyz="0 0.001 0" rpy="0 0 0"/>
            <geometry>
                <box size="0.02 0.02 0.02"/>
            </geometry>
            <surface>
                <contact>
                    <ode>
                        <soft_cfm>0</soft_cfm>
                        <soft_erp>0.2</soft_erp>
                        <kp>1e+5</kp>
                        <kd>1</kd>
                        <max_vel>0.01</max_vel>
                        <min_depth>0.001</min_depth>
                    </ode>
                </contact>
            </surface>
        </collision>
    
        <inertial>
            <origin xyz="0 0 0" />
            <mass value="0.005" />
            <inertia ixx="0.001" ixy="0.0" ixz="0.0"
                    iyy="0.001" iyz="0.0"
                    izz="0.001" />
        </inertial>
    </link>

            <!-- LEGS DEFINITION-->
    <joint name="legs_joint" type="fixed">
        <origin
            xyz="-0.0015188 -0.038639 -0.35111"
            rpy="1.5708 0 0" />
        <parent
            link="base" />
        <child
            link="legs" />
    </joint>

    <link name="legs">
        <inertial>
            <origin 
                xyz="3.13579670600497E-05 0.410501245279509 2.92613595315391E-05"
                rpy="0 0 0" />
            <mass value="0.57830229100239" />
            <inertia
                ixx="0.00974131860411503"
                ixy="-2.4628489310393E-06"
                ixz="7.54615274060419E-08"
                iyy="0.00435809920534734"
                iyz="-2.95659056324959E-07"
                izz="0.013324822888574" />
        </inertial>

        <visual>
            <origin
                xyz="0 0 0"
                rpy="0 0 0" />
            <geometry>
                <mesh filename="package://moria_description/meshes/legs.STL" />
            </geometry>
            <material name="">
                <color rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
            </material>
        </visual>

        <collision>
            <origin
                xyz="0 0 0"
                rpy="0 0 0" />
            <geometry>
                <mesh filename="package://moria_description/meshes/legs.STL" />
            </geometry>
        </collision>
    </link>

            <!--BODY DEFINITION-->
    <joint name="body_joint" type="fixed">
        <origin
            xyz="3.4229E-05 0.5421 0.029896"
            rpy="3.1416 1.4922 -1.5708" />
        <parent link="legs" />
        <child link="body" />
    </joint>

    <link name="body">
        <inertial>
            <origin
                xyz="0.00690202806639532 -7.2816871036846E-05 0.330424705663419"
                rpy="0 0 0" />
            <mass value="0.716072236536923" />
            <inertia
                ixx="0.0131456950439134"
                ixy="-1.50886229692576E-06"
                ixz="0.000424054700669175"
                iyy="0.00972108230104261"
                iyz="6.38231130573314E-07"
                izz="0.00846288278820841" />
        </inertial>
    
        <visual>
            <origin
                xyz="0 0 0"
                rpy="0 0 0" />
            <geometry>
                <mesh filename="package://moria_description/meshes/body.STL" />
            </geometry>
            <material name="">
                <color
                    rgba="0.792156862745098 0.819607843137255 0.933333333333333 1" />
            </material>
        </visual>
    
        <collision>
            <origin
                xyz="0 0 0"
                rpy="0 0 0" />
            <geometry>
                <mesh filename="package://moria_description/meshes/body.STL" />
            </geometry>
        </collision>
    </link>

    <plugin name="moria_diff_drive" filename="libgazebo_ros_diff_drive.so">
        <ros>

        </ros>

        <update_rate>30</update_rate>

        <left_joint>left_wheel_joint</left_joint>
        <right_joint>right_wheel_joint</right_joint>

        <wheel_seperation>0.26</wheel_seperation>
        <wheel_diameter>0.05</wheel_diameter>

        <max_wheel_torque>20</max_wheel_torque>
        <max_wheel_acceleration>1.0</max_wheel_acceleration>

        <command_topic>cmd_vel</command_topic>

        <publish_odom>true</publish_odom>
        <publish_odom_tf>true</publish_odom_tf>
        <publish_wheel_tf>false</publish_wheel_tf>

        <odometry_topic>odom</odometry_topic>
        <odometry_frame>odom</odometry_frame>
        <robot_base_frame>floor</robot_base_frame>
    </plugin>

    <plugin name="moria_joint_state" filename="libgazebo_ros_joint_state_publisher.so">
        <ros>
            <remapping>~/out:=joint_states</remapping>
        </ros>
        <update_rate>30</update_rate>
        <joint_name>left_wheel_joint</joint_name>
        <joint_name>right_wheel_joint</joint_name>
    </plugin>

    <xacro:include filename="sensors.xacro"/>
    <xacro:include filename="camera.xacro"/>
</robot>